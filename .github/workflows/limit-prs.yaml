name: Limit Open PRs
on: [pull_request]
jobs:
    limit-prs:
        runs-on: ubuntu-latest
        steps:
            - name: Check number of open PRs and convert to draft if necessary
              run: |
                  # Get the number of open PRs
                  PR_COUNT=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" | jq -r '. | length')
                  echo "Open PRs: $PR_COUNT"

                  if [[ "$PR_COUNT" -ge 5 ]]; then
                  echo "Limit of 5 open PRs reached. Converting this PR to draft."

                  # Convert the current PR to draft
                  RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X PATCH -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
                    -d '{"draft": true}')

                  echo "Response Code: $RESPONSE"
                  echo "Response Body: $(cat response.txt)"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
